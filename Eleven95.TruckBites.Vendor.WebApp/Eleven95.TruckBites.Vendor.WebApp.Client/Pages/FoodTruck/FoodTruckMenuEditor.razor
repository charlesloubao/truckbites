@page "/foodtrucks/{foodtruckId:long}/menu"
@using Eleven95.TruckBites.Data.Models
@using Eleven95.TruckBites.Services.Interfaces

@inject IFoodTruckAdminService FoodTruckAdminService;

<h3>Edit Menu</h3>

<EditForm EditContext="EditContext" OnValidSubmit="SaveMenuChanges">
    <div>
        <table>
            @foreach (var item in FoodTruck.MenuItems)
            {
                <tr>
                    <td>
                        <InputText @bind-Value="@item.Name" placeholder="Item name"/>
                    </td>
                    <td>
                        $
                        <InputNumber @bind-Value="@item.Price" placeholder="Price"/>
                    </td>
                    <td>
                        <InputCheckbox id="@nameof(FoodTruckMenuItem.IsSoldOut)" @bind-Value="@item.IsSoldOut"/>
                        <label for="@nameof(FoodTruckMenuItem.IsSoldOut)">
                            Sold out
                        </label>
                    </td>
                    <td>
                        <button @onclick="@(() => DeleteMenuItem(item))" type="button">Delete</button>

                    </td>
                </tr>
            }
        </table>
        <button @onclick="AddMenuItem" type="button">Add menu item</button>
        <br/>
        <br/>
        <input type="submit" value="Save changes"/>
    </div>
</EditForm>

@code {
    [CascadingParameter] public FoodTruck FoodTruck { get; set; }
    [Parameter] public long FoodTruckId { get; set; }

    [PersistentState] public EditContext? EditContext { get; set; }

    protected override void OnInitialized()
    {
        if (EditContext != null) return;
        EditContext = new EditContext(FoodTruck);
    }

    private async Task SaveMenuChanges()
    {
        FoodTruck.MenuItems = await FoodTruckAdminService.UpdateFoodTruckMenuAsync(FoodTruck.FoodTruckId, FoodTruck.MenuItems);
    }

    private void AddMenuItem()
    {
        FoodTruck.MenuItems.Add(new FoodTruckMenuItem()
        {
            FoodTruckMenuItemId = -1,
            Name = ""
        });
    }

    private void DeleteMenuItem(FoodTruckMenuItem item)
    {
        FoodTruck.MenuItems.Remove(item);
    }

}